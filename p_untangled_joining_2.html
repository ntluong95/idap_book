<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.56">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Joining 2: Mismatched Values, One-to-Many &amp; Multi-Key Joins</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="p_untangled_joining_2_files/libs/clipboard/clipboard.min.js"></script>
<script src="p_untangled_joining_2_files/libs/quarto-html/quarto.js"></script>
<script src="p_untangled_joining_2_files/libs/quarto-html/popper.min.js"></script>
<script src="p_untangled_joining_2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="p_untangled_joining_2_files/libs/quarto-html/anchor.min.js"></script>
<link href="p_untangled_joining_2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="p_untangled_joining_2_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="p_untangled_joining_2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="p_untangled_joining_2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="p_untangled_joining_2_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Joining 2: Mismatched Values, One-to-Many &amp; Multi-Key Joins</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>Now that we have a solid grasp on the different types of joins and how they work, we can look at how to manage messier and more complex datasets. Joining real-world data from different sources often requires a bit of thought and cleaning ahead of time.</p>
<hr>
</section>
<section id="learning-objectives" class="level1">
<h1>Learning Objectives</h1>
<ul>
<li><p>You know how to check for mismatched values between dataframes</p></li>
<li><p>You understand the concept of a one-to-many join</p></li>
<li><p>You know how to join on multiple key columns</p></li>
</ul>
<hr>
</section>
<section id="datasets" class="level1">
<h1>Datasets</h1>
<p>Run the code below to load and define the datasets to be used in this lesson.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>oil_consumption <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/the-graph-courses/idap_book/main/data/oil_consumption.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 1520 Columns: 3
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): country
dbl (2): year, oil_consump

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>tidyr_population <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/the-graph-courses/idap_book/main/data/tidyr_population.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 4045 Columns: 3
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (1): country
dbl (2): year, population

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>country_regions <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"https://raw.githubusercontent.com/the-graph-courses/idap_book/main/data/country_continent_data.csv"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 242 Columns: 3
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr (3): country_name, country_code, continent

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>oil_2012 <span class="ot">&lt;-</span> oil_consumption <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2012</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">country_code =</span> <span class="fu">countrycode</span>(country, <span class="at">origin =</span> <span class="st">"country.name"</span>, <span class="at">destination =</span> <span class="st">"iso3c"</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="co"># people data</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>people <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">name =</span> <span class="fu">c</span>(<span class="st">"Alice"</span>, <span class="st">"Bob"</span>, <span class="st">"Charlie"</span>), <span class="at">age =</span> <span class="fu">c</span>(<span class="dv">25</span>, <span class="dv">32</span>, <span class="dv">45</span>))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>test_info_many <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>name, <span class="sc">~</span>test_date, <span class="sc">~</span>result,</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alice"</span>, <span class="st">"2023-06-05"</span>, <span class="st">"Negative"</span>,</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Alice"</span>, <span class="st">"2023-06-10"</span>, <span class="st">"Positive"</span>,</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bob"</span>, <span class="st">"2023-08-10"</span>, <span class="st">"Positive"</span>,</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Xavier"</span>, <span class="st">"2023-05-02"</span>, <span class="st">"Negative"</span>,</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Xavier"</span>, <span class="st">"2023-05-12"</span>, <span class="st">"Negative"</span>,</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>farm_info <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>farm_id, <span class="sc">~</span>farm_name, <span class="sc">~</span>location,</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="st">"Green Acres"</span>, <span class="st">"County A"</span>,</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>, <span class="st">"Harvest Hill"</span>, <span class="st">"County B"</span>,</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>, <span class="st">"Golden Fields"</span>, <span class="st">"County A"</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>crop_yields <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>farm_id, <span class="sc">~</span>crop, <span class="sc">~</span>yield_tons,</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="st">"Wheat"</span>, <span class="dv">50</span>,</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>, <span class="st">"Corn"</span>, <span class="dv">60</span>,</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span>, <span class="st">"Soybeans"</span>, <span class="dv">45</span>,</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>, <span class="st">"Wheat"</span>, <span class="dv">55</span>,</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span>, <span class="st">"Barley"</span>, <span class="dv">30</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>traffic_flow <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>street_name, <span class="sc">~</span>time_of_day, <span class="sc">~</span>vehicle_count,</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Main St"</span>, <span class="st">"9am"</span>, <span class="dv">1200</span>,</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Main St"</span>, <span class="st">"2pm"</span>, <span class="dv">900</span>,</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Broadway"</span>, <span class="st">"9am"</span>, <span class="dv">1500</span>,</span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Broadway"</span>, <span class="st">"2pm"</span>, <span class="dv">1100</span>,</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Elm St"</span>, <span class="st">"9am"</span>, <span class="dv">700</span>,</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Elm St"</span>, <span class="st">"2pm"</span>, <span class="dv">600</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>pollution_levels <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>street_name,   <span class="sc">~</span>time_of_day,   <span class="sc">~</span>pm_2_5_level,</span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Main St"</span>,      <span class="st">"9am"</span>,          <span class="fl">35.5</span>,</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Main St"</span>,      <span class="st">"2pm"</span>,          <span class="fl">42.1</span>,</span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Broadway"</span>,     <span class="st">"9am"</span>,          <span class="fl">40.3</span>,</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Broadway"</span>,     <span class="st">"2pm"</span>,          <span class="fl">48.2</span>,</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Elm St"</span>,       <span class="st">"9am"</span>,          <span class="fl">25.7</span>,</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Elm St"</span>,       <span class="st">"2pm"</span>,          <span class="fl">30.9</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>test_info_diff <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>name, <span class="sc">~</span>test_date, <span class="sc">~</span>result,</span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">"alice"</span>, <span class="st">"2023-06-05"</span>, <span class="st">"Negative"</span>,</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Bob"</span>, <span class="st">"2023-08-10"</span>, <span class="st">"Positive"</span>,</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>    <span class="st">"charlie"</span>, <span class="st">"2023-05-02"</span>, <span class="st">"Negative"</span>,</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>asia_countries <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>Country, <span class="sc">~</span>Capital,</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>    <span class="st">"India"</span>, <span class="st">"New Delhi"</span>,</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Indonesia"</span>, <span class="st">"Jakarta"</span>,</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Philippines"</span>, <span class="st">"Manila"</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>asia_population <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span>Country, <span class="sc">~</span>Population, <span class="sc">~</span>Life_Expectancy,</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"India "</span>, <span class="dv">1393000000</span>, <span class="fl">69.7</span>,</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"indonesia"</span>, <span class="dv">273500000</span>, <span class="fl">71.7</span>,</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Philipines"</span>, <span class="dv">113000000</span>, <span class="fl">72.7</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="packages" class="level1">
<h1>Packages</h1>
<p>Please load the packages needed for this lesson with the code below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(pacman)) <span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidyverse, countrycode)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="one-to-many-relationships" class="level1">
<h1>One-to-many relationships</h1>
<p>So far, we have primarily looked at one-to-one joins, where an observation in one dataframe corresponded to only one observation in the other dataframe. In a one-to-many join, an observation one dataframe corresponds to multiple observations in the other dataframe.</p>
<p>The image below illustrates this concept:</p>
<p><img src="images/one_to_many.jpg" class="img-fluid"></p>
<p>To illustrate a one-to-many join, let’s return to our patients and their COVID test data. Let’s imagine that in our dataset, <code>Alice</code> and <code>Xavier</code> got tested multiple times for COVID. We can add two more rows to our <code>test_info</code> dataframe with their new test information:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>people</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  name      age
  &lt;chr&gt;   &lt;dbl&gt;
1 Alice      25
2 Bob        32
3 Charlie    45</code></pre>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>test_info_many</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  name   test_date  result  
  &lt;chr&gt;  &lt;chr&gt;      &lt;chr&gt;   
1 Alice  2023-06-05 Negative
2 Alice  2023-06-10 Positive
3 Bob    2023-08-10 Positive
4 Xavier 2023-05-02 Negative
5 Xavier 2023-05-12 Negative</code></pre>
</div>
</div>
<p>Next, let’s take a look at what happens when we use a <code>left_join()</code> with <code>people</code> as the dataset to the left of the call:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(people, test_info_many)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(name)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4 × 4
  name      age test_date  result  
  &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;   
1 Alice      25 2023-06-05 Negative
2 Alice      25 2023-06-10 Positive
3 Bob        32 2023-08-10 Positive
4 Charlie    45 &lt;NA&gt;       &lt;NA&gt;    </code></pre>
</div>
</div>
<p>What´s happened above? Basically, when you perform a one-to-many join, the data from the “one” side are duplicated for each matching row of the “many” side.</p>
<section id="q-merging-one-to-many-crop-yields" class="level3 unlisted unnumbered practice">
<h3 class="unlisted unnumbered anchored" data-anchor-id="q-merging-one-to-many-crop-yields">Q: Merging One-to-Many Crop Yields</h3>
<p>Run the code below to print the two small dataframes:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>farm_info</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  farm_id farm_name     location
    &lt;dbl&gt; &lt;chr&gt;         &lt;chr&gt;   
1       1 Green Acres   County A
2       2 Harvest Hill  County B
3       3 Golden Fields County A</code></pre>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>crop_yields</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  farm_id crop     yield_tons
    &lt;dbl&gt; &lt;chr&gt;         &lt;dbl&gt;
1       1 Wheat            50
2       1 Corn             60
3       2 Soybeans         45
4       3 Wheat            55
5       3 Barley           30</code></pre>
</div>
</div>
<p>If you use a <code>left_join()</code> to join these datasets, how many rows will be in the final dataframe? Try to figure it out and then perform the join to see if you were right.</p>
</section>
<p>Certainly! Here’s the revised version with <code>9am</code> and <code>2pm</code> instead of <code>morning</code> and <code>evening</code>.</p>
<hr>
</section>
<section id="multiple-key-columns" class="level1">
<h1>Multiple Key Columns</h1>
<p>Sometimes we have more than one column that uniquely identifies the observations that we want to match on. For example, let’s imagine we have traffic flow data for three streets at two different times of day: 9am and 2pm.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>traffic_flow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  street_name time_of_day vehicle_count
  &lt;chr&gt;       &lt;chr&gt;               &lt;dbl&gt;
1 Main St     9am                  1200
2 Main St     2pm                   900
3 Broadway    9am                  1500
4 Broadway    2pm                  1100
5 Elm St      9am                   700
6 Elm St      2pm                   600</code></pre>
</div>
</div>
<p>Now, let’s imagine we have another dataset for the same three streets, recording air pollution levels (measured in particulate matter, <strong>PM2.5</strong>) during the same times of day. Understanding the correlation between traffic volume and pollution levels helps planners optimize interventions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pollution_levels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 3
  street_name time_of_day pm_2_5_level
  &lt;chr&gt;       &lt;chr&gt;              &lt;dbl&gt;
1 Main St     9am                 35.5
2 Main St     2pm                 42.1
3 Broadway    9am                 40.3
4 Broadway    2pm                 48.2
5 Elm St      9am                 25.7
6 Elm St      2pm                 30.9</code></pre>
</div>
</div>
<p>We want to join the two datasets so that each street has two rows: one for the 9am time point and one for the 2pm time point. To do this, our first instinct may be to join the datasets <em>only</em> on <code>street_name</code>. Let’s try it out and see what happens:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>traffic_flow <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(pollution_levels, <span class="at">by =</span> <span class="st">"street_name"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in left_join(., pollution_levels, by = "street_name"): Detected an unexpected many-to-many relationship between `x` and `y`.
ℹ Row 1 of `x` matches multiple rows in `y`.
ℹ Row 1 of `y` matches multiple rows in `x`.
ℹ If a many-to-many relationship is expected, set `relationship =
  "many-to-many"` to silence this warning.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 12 × 5
   street_name time_of_day.x vehicle_count time_of_day.y pm_2_5_level
   &lt;chr&gt;       &lt;chr&gt;                 &lt;dbl&gt; &lt;chr&gt;                &lt;dbl&gt;
 1 Main St     9am                    1200 9am                   35.5
 2 Main St     9am                    1200 2pm                   42.1
 3 Main St     2pm                     900 9am                   35.5
 4 Main St     2pm                     900 2pm                   42.1
 5 Broadway    9am                    1500 9am                   40.3
 6 Broadway    9am                    1500 2pm                   48.2
 7 Broadway    2pm                    1100 9am                   40.3
 8 Broadway    2pm                    1100 2pm                   48.2
 9 Elm St      9am                     700 9am                   25.7
10 Elm St      9am                     700 2pm                   30.9
11 Elm St      2pm                     600 9am                   25.7
12 Elm St      2pm                     600 2pm                   30.9</code></pre>
</div>
</div>
<p>As we can see, this isn’t what we wanted at all! We end up with duplicated rows—now we have <strong>four rows</strong> for each street. R also gives a warning that this is a “many-to-many” relationship, because multiple rows in one dataset (the 9am and 2pm traffic data) match with multiple rows in the other dataset. As a general rule, you should avoid many-to-many joins whenever possible! Also note that, since we have two columns called <code>time_of_day</code> (one from each dataframe), these columns in the new dataframe are differentiated by <code>.x</code> and <code>.y</code>.</p>
<p>What we want to do is match on BOTH <code>street_name</code> AND <code>time_of_day</code>. To do this, we need to tell R to match on two columns. In reality, this process is very simple! We just use the <code>c()</code> function and specify both column names.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>traffic_flow <span class="sc">%&gt;%</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(pollution_levels, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"street_name"</span>, <span class="st">"time_of_day"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 4
  street_name time_of_day vehicle_count pm_2_5_level
  &lt;chr&gt;       &lt;chr&gt;               &lt;dbl&gt;        &lt;dbl&gt;
1 Main St     9am                  1200         35.5
2 Main St     2pm                   900         42.1
3 Broadway    9am                  1500         40.3
4 Broadway    2pm                  1100         48.2
5 Elm St      9am                   700         25.7
6 Elm St      2pm                   600         30.9</code></pre>
</div>
</div>
<section id="q-calculate-oil-consumption-per-capita" class="level3 unlisted unnumbered practice">
<h3 class="unlisted unnumbered anchored" data-anchor-id="q-calculate-oil-consumption-per-capita">Q: Calculate Oil Consumption per Capita</h3>
<p>We have two datasets containing information about countries: - <code>oil_consumption</code>: Contains yearly oil consumption in thousands of barrels per day - <code>tidyr_population</code>: Contains yearly population data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># View the datasets</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>oil_consumption</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,520 × 3
   country     year oil_consump
   &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt;
 1 UAE         1995    20800000
 2 Argentina   1995    20300000
 3 Australia   1995    36500000
 4 Austria     1995    11300000
 5 Azerbaijan  1995     6580000
 6 Belgium     1995    27900000
 7 Bangladesh  1995     2930000
 8 Bulgaria    1995     6210000
 9 Belarus     1995    10700000
10 Brazil      1995    72000000
# ℹ 1,510 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>tidyr_population</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,045 × 3
   country      year population
   &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt;
 1 Afghanistan  1995   17586073
 2 Afghanistan  1996   18415307
 3 Afghanistan  1997   19021226
 4 Afghanistan  1998   19496836
 5 Afghanistan  1999   19987071
 6 Afghanistan  2000   20595360
 7 Afghanistan  2001   21347782
 8 Afghanistan  2002   22202806
 9 Afghanistan  2003   23116142
10 Afghanistan  2004   24018682
# ℹ 4,035 more rows</code></pre>
</div>
</div>
<ol type="1">
<li><p>Join these datasets using a <code>left_join()</code>. Since we want to match both country AND year, you’ll need to join on multiple columns.</p></li>
<li><p>After joining, create a new column called <code>consumption_per_capita</code> that calculates the daily oil consumption per person (in barrels).</p>
<ul>
<li>Hint: You’ll need to divide <code>consumption</code> by <code>population</code> and multiply by 1000 (since consumption is in thousands)</li>
</ul></li>
<li><p>Which country had the highest per capita oil consumption in 2020?</p></li>
</ol>
<p><strong>Solution:</strong></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>oil_consumption <span class="sc">%&gt;%</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Join the datasets</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(tidyr_population, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country"</span>, <span class="st">"year"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate per capita consumption</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">consumption_per_capita =</span> (oil_consump <span class="sc">*</span> <span class="dv">1000</span>) <span class="sc">/</span> population) <span class="sc">%&gt;%</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter for 2020 and sort to find highest</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2020</span>) <span class="sc">%&gt;%</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(consumption_per_capita))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 5
# ℹ 5 variables: country &lt;chr&gt;, year &lt;dbl&gt;, oil_consump &lt;dbl&gt;,
#   population &lt;dbl&gt;, consumption_per_capita &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="pre-join-data-cleaning-addressing-data-inconsistencies" class="level1">
<h1>Pre-join data cleaning: addressing data inconsistencies</h1>
<section id="a-toy-example" class="level2">
<h2 class="anchored" data-anchor-id="a-toy-example">A toy example</h2>
<p>Often you will need to pre-clean your data when you draw it from different sources before you’re able to join it. This is because there can be inconsistencies in ways that values are recorded in different tables such as spelling errors, differences in capitalization, and extra spaces. In order to join values, we need them to match perfectly. If there are any differences, R considers them to be different values.</p>
<p>To illustrate this, let’s return to our mock patient data from the first lesson. If you recall, we had two dataframes, one called <code>people</code> and the other called <code>test_info</code>. We can recreate these datasets but change <code>Alice</code> to <code>alice</code> in the <code>people</code> dataset and keep all other values the same.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>people</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  name      age
  &lt;chr&gt;   &lt;dbl&gt;
1 Alice      25
2 Bob        32
3 Charlie    45</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>test_info_diff</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  name    test_date  result  
  &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;   
1 alice   2023-06-05 Negative
2 Bob     2023-08-10 Positive
3 charlie 2023-05-02 Negative</code></pre>
</div>
</div>
<p>Now let’s try a <code>left_join()</code> and <code>inner_join()</code> on our two datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(people, test_info_diff, <span class="at">by =</span> <span class="st">"name"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  name      age test_date  result  
  &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;   
1 Alice      25 &lt;NA&gt;       &lt;NA&gt;    
2 Bob        32 2023-08-10 Positive
3 Charlie    45 &lt;NA&gt;       &lt;NA&gt;    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inner_join</span>(people, test_info_diff, <span class="at">by =</span> <span class="st">"name"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  name    age test_date  result  
  &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;   
1 Bob      32 2023-08-10 Positive</code></pre>
</div>
</div>
<p>As we can see, R didn’t recognize <code>Alice</code> and <code>alice</code> as the same person, and it also could not match <code>Charlie</code> and <code>charlie</code>. So in the <code>left_join()</code>, <code>Alice</code> and <code>Charlie</code> are left with NAs, and in the <code>inner_join()</code>, they are dropped.</p>
<p>How can we fix this? We need to ensure that the names in both datasets are in title case, with a capitalized first letter. For this we can use <code>str_to_title()</code>. Let’s try it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>test_info_title <span class="ot">&lt;-</span> test_info_diff <span class="sc">%&gt;%</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">name =</span> <span class="fu">str_to_title</span>(name)) <span class="co"># convert to title case</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>test_info_title</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  name    test_date  result  
  &lt;chr&gt;   &lt;chr&gt;      &lt;chr&gt;   
1 Alice   2023-06-05 Negative
2 Bob     2023-08-10 Positive
3 Charlie 2023-05-02 Negative</code></pre>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(people, test_info_title, <span class="at">by =</span> <span class="st">"name"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  name      age test_date  result  
  &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;   
1 Alice      25 2023-06-05 Negative
2 Bob        32 2023-08-10 Positive
3 Charlie    45 2023-05-02 Negative</code></pre>
</div>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inner_join</span>(people, test_info_title, <span class="at">by =</span> <span class="st">"name"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 4
  name      age test_date  result  
  &lt;chr&gt;   &lt;dbl&gt; &lt;chr&gt;      &lt;chr&gt;   
1 Alice      25 2023-06-05 Negative
2 Bob        32 2023-08-10 Positive
3 Charlie    45 2023-05-02 Negative</code></pre>
</div>
</div>
<p>That worked perfectly! We won’t go into detail about all the different functions we can use to modify strings. The important part of this lesson is that we will learn how to identify mismatched values between dataframes.</p>
<div class="practice">
<p><em>(NOTE: Answers are at the bottom of the page. Try to answer the questions yourself before checking.)</em></p>
<section id="q-inner-join-countries" class="level3 unlisted unnumbered">
<h3 class="unlisted unnumbered anchored" data-anchor-id="q-inner-join-countries">Q: Inner Join countries</h3>
<p>The following two datasets contain data for India, Indonesia, and the Philippines. However an <code>inner_join()</code> of these datasets produces no output. What are the differences between the values in the key columns that would have to be changed before joining the datasets?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>asia_countries</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 2
  Country     Capital  
  &lt;chr&gt;       &lt;chr&gt;    
1 India       New Delhi
2 Indonesia   Jakarta  
3 Philippines Manila   </code></pre>
</div>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>asia_population</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 3
  Country      Population Life_Expectancy
  &lt;chr&gt;             &lt;dbl&gt;           &lt;dbl&gt;
1 "India "     1393000000            69.7
2 "indonesia"   273500000            71.7
3 "Philipines"  113000000            72.7</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inner_join</span>(asia_countries, asia_population)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Joining with `by = join_by(Country)`</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 4
# ℹ 4 variables: Country &lt;chr&gt;, Capital &lt;chr&gt;, Population &lt;dbl&gt;,
#   Life_Expectancy &lt;dbl&gt;</code></pre>
</div>
</div>
</section>
</div>
</section>
<section id="real-data-example-1-key-typos" class="level2">
<h2 class="anchored" data-anchor-id="real-data-example-1-key-typos">Real Data Example 1: Key Typos</h2>
<p>Let’s now return to the oil consumption example.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>oil_consumption</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,520 × 3
   country     year oil_consump
   &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt;
 1 UAE         1995    20800000
 2 Argentina   1995    20300000
 3 Australia   1995    36500000
 4 Austria     1995    11300000
 5 Azerbaijan  1995     6580000
 6 Belgium     1995    27900000
 7 Bangladesh  1995     2930000
 8 Bulgaria    1995     6210000
 9 Belarus     1995    10700000
10 Brazil      1995    72000000
# ℹ 1,510 more rows</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>tidyr_population</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 4,045 × 3
   country      year population
   &lt;chr&gt;       &lt;dbl&gt;      &lt;dbl&gt;
 1 Afghanistan  1995   17586073
 2 Afghanistan  1996   18415307
 3 Afghanistan  1997   19021226
 4 Afghanistan  1998   19496836
 5 Afghanistan  1999   19987071
 6 Afghanistan  2000   20595360
 7 Afghanistan  2001   21347782
 8 Afghanistan  2002   22202806
 9 Afghanistan  2003   23116142
10 Afghanistan  2004   24018682
# ℹ 4,035 more rows</code></pre>
</div>
</div>
<p>Recall that we had some issues with the <code>tidyr_population</code> dataset because the country names were not in the same format as in the <code>oil_consumption</code> dataset.</p>
<p>Let’s see which countries failed to find a match in the <code>tidyr_population</code> dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(oil_consumption, tidyr_population, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country"</span>, <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">is.na</span>(population)) <span class="sc">|&gt;</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(country)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 13 × 1
   country         
   &lt;chr&gt;           
 1 UAE             
 2 UK              
 3 Hong Kong, China
 4 Iran            
 5 South Korea     
 6 North Macedonia 
 7 Russia          
 8 Slovak Republic 
 9 Taiwan          
10 USA             
11 USSR            
12 Venezuela       
13 Vietnam         </code></pre>
</div>
</div>
<p>It is hard to be sure whether this is because the population data is not available for these countries or because the country names are not spelled the same way in the two datasets.</p>
<p>To avoid such mismatches, it is often useful to use country codes rather than country names as the key.</p>
<p>Let’s now add country codes to both datasets and try the join again.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>oil_consumption <span class="ot">&lt;-</span> oil_consumption <span class="sc">|&gt;</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">country_code =</span> <span class="fu">countrycode</span>(country, <span class="at">origin =</span> <span class="st">"country.name"</span>, <span class="at">destination =</span> <span class="st">"iso3c"</span>))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>tidyr_population <span class="ot">&lt;-</span> tidyr_population <span class="sc">|&gt;</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">country_code =</span> <span class="fu">countrycode</span>(country, <span class="at">origin =</span> <span class="st">"country.name"</span>, <span class="at">destination =</span> <span class="st">"iso3c"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(oil_consumption, tidyr_population, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country_code"</span>, <span class="st">"year"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1,520 × 6
   country.x   year oil_consump country_code country.y            population
   &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;                     &lt;dbl&gt;
 1 UAE         1995    20800000 ARE          United Arab Emirates    2346305
 2 Argentina   1995    20300000 ARG          Argentina              34833168
 3 Australia   1995    36500000 AUS          Australia              18124234
 4 Austria     1995    11300000 AUT          Austria                 7985372
 5 Azerbaijan  1995     6580000 AZE          Azerbaijan              7770806
 6 Belgium     1995    27900000 BEL          Belgium                10161914
 7 Bangladesh  1995     2930000 BGD          Bangladesh            119869585
 8 Bulgaria    1995     6210000 BGR          Bulgaria                8358116
 9 Belarus     1995    10700000 BLR          Belarus                10189075
10 Brazil      1995    72000000 BRA          Brazil                161890816
# ℹ 1,510 more rows</code></pre>
</div>
</div>
<p>We can also check if there are any cases where there was no match found for the country code.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(oil_consumption, tidyr_population, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"country_code"</span>, <span class="st">"year"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">is.na</span>(population)) <span class="sc">|&gt;</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>(country_code)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  country_code
  &lt;chr&gt;       
1 TWN         </code></pre>
</div>
</div>
<p>It seems TWN (Taiwan) failed to find a match.</p>
<p>Let’s make sure that Taiwan is in the <code>tidyr_population</code> dataset.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>tidyr_population <span class="sc">|&gt;</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(country_code <span class="sc">==</span> <span class="st">"TWN"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 4
# ℹ 4 variables: country &lt;chr&gt;, year &lt;dbl&gt;, population &lt;dbl&gt;,
#   country_code &lt;chr&gt;</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>tidyr_population <span class="sc">|&gt;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">str_detect</span>(country, <span class="st">"Taiwan"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 0 × 4
# ℹ 4 variables: country &lt;chr&gt;, year &lt;dbl&gt;, population &lt;dbl&gt;,
#   country_code &lt;chr&gt;</code></pre>
</div>
</div>
<p>Nope. We don’t have it.</p>
<section id="q-merging-tb-cases-with-geographic-data" class="level3 unlisted unnumbered">
<h3 class="unlisted unnumbered anchored" data-anchor-id="q-merging-tb-cases-with-geographic-data">Q: Merging TB Cases with Geographic Data</h3>
<p>Run the code to view the two datasets.</p>
<p>The first, <code>oil_2012</code> records the oil consumption for the year 2012:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>oil_2012</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 80 × 4
   country     year oil_consump country_code
   &lt;chr&gt;      &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;       
 1 UAE         2012    35200000 ARE         
 2 Argentina   2012    28600000 ARG         
 3 Australia   2012    46100000 AUS         
 4 Austria     2012    11900000 AUT         
 5 Azerbaijan  2012     4170000 AZE         
 6 Belgium     2012    29900000 BEL         
 7 Bangladesh  2012     5440000 BGD         
 8 Bulgaria    2012     4110000 BGR         
 9 Belarus     2012    10400000 BLR         
10 Brazil      2012   116000000 BRA         
# ℹ 70 more rows</code></pre>
</div>
</div>
<p>And <code>country_regions</code> lists countries along with their respective regions and continents:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>country_regions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 242 × 3
   country_name        country_code continent 
   &lt;chr&gt;               &lt;chr&gt;        &lt;chr&gt;     
 1 Afghanistan         AFG          Asia      
 2 Albania             ALB          Europe    
 3 Algeria             DZA          Africa    
 4 American Samoa      ASM          Oceania   
 5 Andorra             AND          Europe    
 6 Angola              AGO          Africa    
 7 Anguilla            AIA          Americas  
 8 Antarctica          ATA          Antarctica
 9 Antigua and Barbuda ATG          Americas  
10 Argentina           ARG          Americas  
# ℹ 232 more rows</code></pre>
</div>
</div>
<p>Join the two datasets using the country codes as the key. Then find the countries with the highest oil consumption in each continent. As a sanity check, your answer should include the US &amp; China.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r tgc-code-block code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># | eval: false</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># | echo: false</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="fu">left_join</span>(oil_2012, country_regions, <span class="at">by =</span> <span class="st">"country_code"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(continent) <span class="sc">%&gt;%</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">slice_max</span>(<span class="at">order_by =</span> oil_consump, <span class="at">n =</span> <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 6
# Groups:   continent [5]
  country    year oil_consump country_code country_name                continent
  &lt;chr&gt;     &lt;dbl&gt;       &lt;dbl&gt; &lt;chr&gt;        &lt;chr&gt;                       &lt;chr&gt;    
1 Egypt      2012    35300000 EGY          Egypt                       Africa   
2 USA        2012   778000000 USA          United States of America (… Americas 
3 China      2012   484000000 CHN          China                       Asia     
4 Russia     2012   145000000 RUS          Russian Federation (the)    Europe   
5 Australia  2012    46100000 AUS          Australia                   Oceania  </code></pre>
</div>
</div>
<p>:::</p>
</section>
</section>
</section>
<section id="wrap-up" class="level1">
<h1>Wrap Up!</h1>
<p>In this lesson, we delved into the intricacies of data cleaning before a join, focusing on how to detect and correct mismatches or inconsistencies in key columns. We also highlighted the impact of one-to-many relationships in joining dataframes, showing how data from the “one” side is duplicated for each matching row of the “many” side. Finally, we demonstrated how to join dataframes using multiple key columns.</p>
<p>As we conclude this lesson, we hope that you have gained a deeper understanding of the importance and utility of joining dataframes in R.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>